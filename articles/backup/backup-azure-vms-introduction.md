---
title: 關於 Azure VM 備份
description: 深入了解 Azure VM 備份，並記下一些最佳做法。
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 03/04/2019
ms.author: raynew
ms.openlocfilehash: 93be913182db56941c346ef0cad47f70c0d614c9
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/13/2019
ms.locfileid: "64706843"
---
# <a name="about-azure-vm-backup"></a>關於 Azure VM 備份

這篇文章說明如何[Azure 備份服務](backup-introduction-to-azure-backup.md)備份 Azure 虛擬機器 (Vm)。

## <a name="backup-process"></a>備份程序

以下是 Azure 備份完成的方式備份 Azure vm:

1. 選取要備份的 Azure vm，Azure 備份會開始根據您指定的備份排程備份作業。
1. 期間第一次的備份，備份擴充功能會安裝在 VM 上，如果 VM 正在執行。
    - 適用於 Windows Vm _VMSnapshot_安裝擴充功能。
    - 適用於 Linux Vm _VMSnapshotLinux_安裝擴充功能。
1. 對於執行 Windows Vm，備份會協調與 Windows 磁碟區陰影複製服務 (VSS) 建立 VM 的應用程式一致快照集。
    - 根據預設，完整的 VSS 備份會備份。
    - 如果備份無法建立應用程式一致的快照集，然後會在基礎儲存體的檔案一致快照集 （因為 VM 停止時，就會不發生任何應用程式寫入）。
1. 適用於 Linux Vm 備份會進行檔案一致備份。 對於應用程式一致快照集，您需要以手動方式自訂前置/後置指令碼。
1. 備份會擷取快照集之後，它會將資料傳輸至保存庫中。
    - 備份已最佳化來以平行方式每個 VM 磁碟備份。
    - 針對每個要備份的磁碟，Azure 備份會讀取磁碟上的區塊和識別並只傳輸這些資料區塊上一次備份以來變更 （差異）。
    - 快照集資料可能不會立即複製到保存庫。 這在尖峰時間可能需耗費數小時。 適用於 VM 的備份時間總計會小於 24 小時的每日備份原則。
 1. Windows VM 上啟用 Azure 備份之後所做的變更如下：
    -   Microsoft Visual C++ 2013 Redistributable(x64)-12.0.40660 安裝到 VM 中
    -   磁碟區陰影複製服務 (VSS) 從手動變更為自動啟動類型
    -   新增 IaaSVmProvider Windows 服務

1. 資料傳輸完成時，會移除快照集，並建立復原點。

![Azure 虛擬機器備份架構](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="encryption-of-azure-vm-backups"></a>加密 Azure VM 備份

當您使用 Azure 備份來備份 Azure VM 時，VM 會透過儲存體服務加密 (SSE) 來執行待用加密。 Azure 備份也可以備份會使用 Azure 磁碟加密來加密的 Azure Vm。

**加密** | **詳細資料** | **支援**
--- | --- | ---
**Azure 磁碟加密** | Azure 磁碟加密會加密 Azure Vm 的 OS 和資料磁碟。<br/><br/> Azure 磁碟加密會與 BitLocker 加密金鑰 (BEKs)，這會在金鑰保存庫中受到保護為祕密整合。 Azure 磁碟加密也整合了 Azure Key Vault 的金鑰加密金鑰 (Kek)。 | Azure 備份支援 BEKs，或含 BEKs 與 Kek 加密的受控和非受控 Azure Vm 的備份。<br/><br/> BEKs 和的 Kek 會備份和加密。<br/><br/> Kek 和 BEKs 會備份，因為必要的權限的使用者就可以還原金鑰和祕密回金鑰保存庫，如有需要。 這些使用者也可以復原加密的 VM。<br/><br/> 無法讀取加密的金鑰和祕密，未經授權的使用者或 azure。
**SSE** | 使用 SSE，Azure 儲存體提供待用加密之後，自動將資料加密再將其儲存。 Azure 儲存體也會擷取它之前解密資料。 | Azure 備份會進行待用加密的 Azure Vm 使用 SSE。

適用於受控和非受控 Azure Vm 備份支援只使用 BEKs 加密的 Vm 或使用 BEKs 與 Kek 加密的 Vm。

加密備份 BEKs （密碼） 和的 Kek （索引鍵）。 他們可以讀取及它們由授權的使用者還原回金鑰保存庫時，才使用。 未經授權的使用者和 Azure 都不可以讀取，或使用備份金鑰或密碼。

BEKs 也會備份。 因此，如果 BEKs 遺失，經過授權的使用者就可以 BEKs 還原至金鑰保存庫和復原加密的 Vm。 只有具有所需的層級的權限的使用者可以備份和還原已加密的 Vm 或金鑰和祕密。

## <a name="snapshot-creation"></a>建立快照集

Azure 備份會根據備份排程的快照集。

- **Windows Vm:** 適用於 Windows Vm，備份服務會協調使用 VSS，以建立 VM 磁碟的應用程式一致快照集。

  - 根據預設，Azure 備份會建立完整的 VSS 備份。 [深入了解](https://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx)。
  - 若要變更設定，以便 Azure 備份建立 VSS 複製備份，請從命令提示字元設定下列登錄機碼：

    **REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgent" /v USEVSSCOPYBACKUP /t REG_SZ /d TRUE /f**

- **Linux Vm:** 若要建立的 Linux Vm 的應用程式一致快照集，使用 Linux 前置指令碼和後置指令碼架構來撰寫您自己自訂的指令碼，以確保一致性。

  - Azure 備份會叫用只有前置/後置指令碼由您撰寫。
  - 如果前指令碼和後置指令碼執行成功，Azure 備份將標示為應用程式一致復原點。 不過，當您使用自訂指令碼時，您的應用一致性負最終責任。
  - [了解更多](backup-azure-linux-app-consistent.md)有關如何設定指令碼。

### <a name="snapshot-consistency"></a>快照集一致性

下表說明不同類型的快照集一致性：

**快照集** | **詳細資料** | **復原** | **考量**
--- | --- | --- | ---
**應用程式一致** | 應用程式一致的備份會擷取記憶體內容和擱置 I/O 作業。 應用程式一致快照集使用 VSS 寫入器 （或前置/後置指令碼，適用於 Linux） 之前的備份，就會發生，請確認應用程式資料的一致性。 | 當您要復原的應用程式一致快照集的 VM 時，VM 會啟動。 沒有任何資料損毀或遺失。 應用程式會以一致的狀態開始。 | Windows:所有 VSS 寫入器都已成功<br/><br/> Linux：前置/後置指令碼已設定並成功
**檔案系統保持一致** | 檔案系統一致的備份所建立的所有檔案快照集，同時提供一致性。<br/><br/> | 當您要復原檔案系統一致快照集的 VM 時，VM 會啟動。 沒有任何資料損毀或遺失。 應用程式必須實作自己的「修正」機制，以確保還原的資料一致。 | Windows:部分 VSS 寫入器失敗 <br/><br/> Linux：預設值 （如果未設定前置/後置指令碼，或失敗）
**絕對一致** | 如果 Azure VM 在備份期間關閉，通常會發生損毀一致的快照集。 只會擷取備份時已存在磁碟上的資料，並加以備份。<br/><br/> 絕對一致性復原點並不保證作業系統或應用程式的資料一致性。 | 雖然沒有任何保證，通常啟動 VM，並再啟動磁碟檢查，以修正損毀錯誤。 任何記憶體中的資料或未傳送的寫入作業至磁碟之前損毀都會遺失。 應用程式會實作本身的資料驗證。 例如，資料庫應用程式可以使用其交易記錄進行驗證。 如果交易記錄中有項目不存在於資料庫中，資料庫軟體，它會復原交易，直到資料變成一致。 | VM 處於關機狀態

## <a name="backup-and-restore-considerations"></a>備份和還原考量

**考量** | **詳細資料**
--- | ---
**磁碟** | 備份 VM 磁碟是平行。 例如，如果 VM 有四個磁碟，備份服務會嘗試備份全部 4 個磁碟，以平行方式。 備份是累進的 (僅備份已變更的資料)。
**排程** |  若要減少備份流量，在一天的不同時間備份不同的 Vm 並確定的時間不重疊。 同時間備份多個 VM 會導致流量壅塞。
**準備備份** | 請記住準備備份所需的時間。 準備時間包含安裝或更新備份擴充功能，以及觸發根據的備份排程快照集。
**資料傳輸** | 請考慮所需的 Azure 備份來識別上一次備份的增量變更的時間。<br/><br/> 在增量備份，Azure 備份會決定所做的變更藉由計算區塊的總和檢查碼。 如果區塊已變更，則會將其標示為傳輸到保存庫。 服務會分析已識別的區塊，以嘗試進一步降低要傳輸的資料量。 後評估所有已變更的區塊，Azure 備份會傳輸至保存庫所做的變更。<br/><br/> 擷取快照集和將其複製到保存庫之間可能會有延遲。<br/><br/> 在尖峰時間，可能需要最多八個小時處理的備份。 若每日備份，則 VM 的備份時間會小於 24 小時。
**初始備份** | 雖然備份的增量備份時間總計會小於 24 小時，這可能不是第一次備份的情況。 初始備份所需的時間將取決於的資料和處理備份的大小。
**還原佇列** | Azure 備份處理程序從多個儲存體帳戶還原作業，在此同時，它會將還原要求放在佇列中。
**還原複本** | 進行還原時，資料會從保存庫複製到儲存體帳戶。<br/><br/> 總計還原時間取決於每秒 (IOPS) 和儲存體帳戶的輸送量的 I/O 作業。<br/><br/> 若要減少複製時間，請選取未使用其他應用程式寫入或讀取載入的儲存體帳戶。

### <a name="backup-performance"></a>備份效能

這些常見的案例可能會影響備份時間總計：

- **將新的磁碟新增至受保護的 Azure VM 中：** 如果 VM 正在進行增量備份，並加入新的磁碟，則會增加備份時間。 備份的時間總計可能持續超過 24 小時，因為新的磁碟，以及現有磁碟的差異複寫的初始複寫。
- **分散的磁碟：** 連續磁碟上的變更時，備份作業會比較快。 如果變更分散在磁碟中，則備份會必較慢。
- **磁碟變換：** 如果保護正在進行增量備份的磁碟有 200 GB 以上的每日變換，備份可能需要很長的時間 （超過八個小時） 才能完成。
- **備份的版本：** 最新版的備份 （稱為 「 立即還原版 」） 會使用總和檢查碼比較更進一步最佳化程序，用來識別變更。 但是，如果您正在使用立即還原 」，且已刪除的備份快照集，備份就會切換至總和檢查碼比較。 在此情況下，備份作業將會超過 24 小時 （或失敗）。

## <a name="best-practices"></a>最佳作法

當您設定 VM 備份時，建議您遵循這些作法：

- 修改預設排程時間原則中設定的。 比方說，如果在原則中的預設時間是上午 12:00，增加幾分鐘的時間，以便以最佳方式使用資源。
- 使用進階儲存體的 Vm 備份，建議您執行最新版的 Azure 備份 ([立即還原](backup-instant-restore-capability.md))。 如果您不執行最新版本，備份會配置大約 50%的總儲存空間。 備份服務會需要此空間來將快照集複製到相同的儲存體帳戶，並將它傳輸到保存庫。
- 如果您要在單一保存庫還原 Vm，我們強烈建議您使用不同[一般用途 v2 儲存體帳戶](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade)以確保目標儲存體帳戶不會進行節流。 例如，每個 VM 必須有不同的儲存體帳戶。 比方說，如果 10 個 Vm 還原，使用 10 個不同的儲存體帳戶。
- 從一般用途 v1 儲存層 (snapshot) 還原會完成以分鐘為單位，因為快照集是在相同的儲存體帳戶中。 從一般用途 v2 儲存層 （保存庫） 的還原可能需要小時。 在一般用途 v1 儲存體中，您可使用資料的情況下，我們建議您使用[立即還原](backup-instant-restore-capability.md)更快速的還原功能。 （如果必須從保存庫還原資料，然後它會需要更多的時間）。
- 每個儲存體帳戶的磁碟數目的限制是相對於多磁碟正在存取即服務 (IaaS) VM 的基礎結構執行的應用程式。 一般的作法是，如果 5 到 10 的磁碟或多個有單一的儲存體帳戶，會平衡負載移至不同的儲存體帳戶的某些磁碟。

## <a name="backup-costs"></a>備份成本

使用 Azure 備份所備份的 Azure VM 適用 [Azure 備份定價](https://azure.microsoft.com/pricing/details/backup/)。

第一次成功備份完成之前，不會開始計費。 儲存體和受保護的 VM 也會在此同時開始計費。 只要 VM 的任何備份資料會儲存在保存庫，就會繼續計費。 如果您停止保護 VM，但 VM 的備份資料仍在保存庫中，則還是會繼續計費。

只有在停止保護且刪除全部備份資料時，才會對指定的虛擬機器停止計費。 當保護停止且沒有任何作用中的備份作業時，最後一個成功 VM 備份的大小會成為每月帳單所使用的受保護執行個體大小。

受保護執行個體大小的計算根據*實際*的 VM 大小。 VM 的大小是在 VM 中暫存空間除外的所有資料的總和。 定價根據儲存在資料磁碟上，不能在最大支援大小每個資料磁碟連結至 VM 的實際資料。

同樣地，備份儲存體費用根據儲存在 Azure 備份，也就是每個復原點的實際資料總和的資料量。

例如，需要有兩個額外資料磁碟大小上限為 4 TB 的 A2 標準大小的 VM。 下表顯示每個這些磁碟上儲存的實際資料：

**磁碟** | **大小上限** | **實際儲存的資料**
--- | --- | ---
作業系統磁碟 | 4095 GB | 17 GB
本機/暫存磁碟 | 135 GB | 5 GB (未包含備份)
資料磁碟 1 | 4095 GB | 30 GB
資料磁碟 2 | 4095 GB | 0 GB

在此案例中，VM 的實際容量為 17 GB + 30 GB + 0 GB = 47 GB。 此受保護執行個體大小 (47 GB) 會成為每月帳單。 在 VM 中的資料量增加時，受保護執行個體大小會計費變更用來比對。

## <a name="next-steps"></a>後續步驟

現在，請[準備 Azure VM 備份](backup-azure-arm-vms-prepare.md)。
