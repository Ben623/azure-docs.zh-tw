---
title: 容錯移轉和修補-Azure Cache for Redis |Microsoft Docs
description: 瞭解 Azure Cache for Redis 的容錯移轉、修補和更新程式。
services: cache
author: asasine
ms.assetid: 928b9b9c-d64f-4252-884f-af7ba8309af6
ms.service: cache
ms.workload: tbd
ms.tgt_pltfrm: cache
ms.topic: conceptual
ms.date: 10/18/2019
ms.author: adsasine
ms.openlocfilehash: 305511efe86d2b241ef5014d9c3f0501cfd3fbdc
ms.sourcegitcommit: 9a4296c56beca63430fcc8f92e453b2ab068cc62
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/20/2019
ms.locfileid: "72675898"
---
# <a name="failover-and-patching-for-azure-cache-for-redis"></a>Azure Cache for Redis 的容錯移轉和修補

瞭解什麼是 Azure Cache for Redis 服務的容錯移轉，對於建立可復原且成功的用戶端應用程式而言非常重要。 快取容錯移轉的常見原因來自于管理服務修補 Redis 的二進位檔。 本文涵蓋容錯移轉是什麼、如何在修補期間進行，以及如何建立可復原的用戶端應用程式。

## <a name="what-is-a-failover"></a>什麼是容錯移轉？

### <a name="a-quick-summary-of-our-architecture"></a>架構的快速摘要

快取是以不同的私人 Ip 來構成多部虛擬機器。 每部虛擬機器（也稱為節點）都會連接到具有單一虛擬 IP 的共用負載平衡器。 每個節點都會執行 Redis 伺服器進程，而且可透過主機名稱和 Redis 埠來存取。 每個節點都可以視為主要或複本節點。 當用戶端應用程式連線到快取時，其流量會通過此負載平衡器，並自動路由傳送至主要節點。

在基本快取中，單一節點一律為「主要」。 在標準或高階快取中，有兩個節點選擇了主伺服器，另一個則是複本。 因為 Standard 和 Premium 快取有多個節點，所以一個節點可能無法使用，而另一個則會繼續處理要求。 叢集快取是由許多分區組成，每個都有不同的主要和複本節點。 一個分區可能會關閉，而其他則維持可用狀態。

> [!NOTE]
> 基本快取沒有多個節點，且未提供可用性的 SLA。 基本快取僅建議用於開發和測試用途。 針對多重節點部署使用標準或高階快取來增加可用性。

### <a name="a-failover-explained"></a>已說明容錯移轉

當複本節點將自己升級為主要節點，而舊的主要節點關閉現有的連接時，就會發生容錯移轉。 主要節點恢復運作後，會注意到角色的變更，並將其本身降級成為複本。 接著，它會連接到新的主伺服器，並同步處理資料。 容錯移轉可能已規劃或未計畫。

規劃的容錯移轉會在系統更新期間發生，例如 Redis 修補或作業系統升級以及管理作業，例如調整和重新開機。 因為節點會獲得更新的先進通知，所以他們可以合作交換角色並快速更新變更的負載平衡器。 規劃的容錯移轉應該會在小於1秒的時間內完成。

未計畫的容錯移轉可能是因為硬體故障、網路失敗或其他非預期的主要節點中斷所造成。 複本節點會將其本身升級為 master，但進程需要較長的時間。 複本節點必須先偵測到其主要節點無法使用，才可起始容錯移轉程式。 複本節點也必須確認此未計畫的失敗不是暫時性或本機，以避免 overeager 容錯移轉。 此偵測延遲表示未計畫的容錯移轉通常會在10到15秒內完成。

## <a name="how-does-patching-occur"></a>如何進行修補？

Azure Cache for Redis 服務會定期進行維護，以使用最新的平臺功能和修正程式來更新您的快取。 若要修補快取，服務會遵循下列步驟：

1. 管理服務會選取一個要修補的節點。
1. 如果選取的節點是主要節點，其複本節點會以合作方式自行升級。 這種升級會被視為計畫的容錯移轉。
1. 選取的節點會重新開機以進行新的變更，並將其恢復為複本節點。 複本節點會連接到主要節點並同步處理資料。
1. 當資料同步完成時，會針對其餘節點重複修補程式。

由於修補是規劃的容錯移轉，因此複本節點會快速地將其本身升級為主伺服器，並開始處理要求和新的連接。 基本快取沒有複本節點，在更新完成之前無法使用。 叢集快取的每個分區會分別進行修補，而且不會關閉與其他分區的連線。

> [!IMPORTANT]
> 系統會一次修補一個節點，以防止資料遺失。 基本快取會遺失資料。 叢集快取會一次修補一個分區。

相同資源群組和區域中的多個快取一次也會進行修補。  位於不同資源群組或不同區域的快取可能會同時進行修補。

由於完整資料同步處理會在程式重複之前進行，因此使用標準或高階快取時，不太可能發生資料遺失。 您可以使用[匯出](cache-how-to-import-export-data.md#export)資料並啟用[持續](cache-how-to-premium-persistence.md)性，進一步防範資料遺失。

### <a name="additional-cache-load"></a>額外的快取負載

發生容錯移轉時，Standard 和 Premium 快取必須將資料從一個節點複寫到另一個。 這項複寫會導致伺服器記憶體和 CPU 的負載增加。 如果快取實例已經過大量載入，用戶端應用程式可能會遇到延遲增加的情況。 在極端情況下，用戶端應用程式可能會收到超時例外狀況。 [設定快](cache-configure.md#memory-policies)取的 `maxmemory-reserved` 設定，以協助降低此額外負載的影響。

## <a name="how-does-a-failover-impact-my-client-application"></a>容錯移轉如何影響我的用戶端應用程式？

用戶端應用程式所看到的錯誤數目，將取決於容錯移轉時，該連線上有多少作業正在等待。 透過已關閉連接的節點路由傳送的任何連接都會看到錯誤。 許多用戶端程式庫可能會擲回不同類型的錯誤，包括超時例外狀況、連接例外狀況，或連接中斷時的通訊端例外狀況。 例外狀況的數目和類型取決於當快取關閉其連接時，要求的程式碼路徑中的位置。 例如，在容錯移轉發生時傳送要求但未收到回應的作業，可能會收到超時例外狀況。 在關閉的連線物件上的新要求將會收到連接例外狀況，直到重新連接成功為止。

大部分的用戶端程式庫會嘗試重新連接到快取（如果設定這麼做），但未預期的錯誤可能會導致程式庫物件進入無法復原的狀態。 如果錯誤保存超過預先設定的時間量，則應該重新建立連線物件。 在 .NET 和其他物件導向的語言中，在不重新開機應用程式的情況下重建連接可以使用[延遲 \<T \> 模式](https://gist.github.com/JonCole/925630df72be1351b21440625ff2671f#reconnecting-with-lazyt-pattern)來完成。

### <a name="what-should-i-do-in-my-application"></a>我應該在我的應用程式中做什麼？

由於無法完全避免容錯移轉，因此應撰寫用戶端應用程式，以因應連接中斷和失敗要求的復原能力。 雖然大部分的用戶端程式庫會自動重新連接到快取端點，但少數用戶端程式庫會嘗試重試失敗的要求 視應用程式案例而定，使用輪詢重試邏輯可能會有意義。

若要測試用戶端應用程式的復原功能，請使用[重新開機](cache-administration.md#reboot)作為連接中斷的手動觸發程式。 此外，建議您在快取上[排程更新](cache-administration.md#schedule-updates)，以告知管理服務在指定的每週時段內套用 Redis 執行時間修補程式。 這些視窗通常是在用戶端應用程式流量較低時選擇，以避免潛在的事件。

### <a name="client-network-configuration-changes"></a>用戶端網路設定變更

某些用戶端網路設定變更可能會觸發「沒有可用的連線」錯誤。  在預備和生產位置之間交換用戶端應用程式的虛擬 IP 位址，或調整應用程式實例的大小/數目，可能會導致過去不到一分鐘的連線問題。 除了 Redis 之外，您的用戶端應用程式可能會失去與其他外部網路資源的連接。

## <a name="next-steps"></a>後續步驟

- [排程](cache-administration.md#schedule-updates)快取的更新。
- 使用[重新開機](cache-administration.md#reboot)來測試應用程式復原。
- [設定](cache-configure.md#memory-policies)記憶體保留和原則。
